# Starstream DSL - Consolidated Project

This folder contains the consolidated Starstream DSL project with all components merged from the split architecture.

## ðŸš€ Quick Start

### Run the Example
```bash
cargo run --example simple
```

### Run Tests
```bash
# Run all tests
cargo test

# Run snapshot tests specifically
cargo test --test snapshot_tests

# Run a specific snapshot test
cargo test --test snapshot_tests test_simple_arithmetic

# Update all snapshots
UPDATE_SNAPSHOTS=1 cargo test --test snapshot_tests update_all_snapshots
```

### Build for WASM
```bash
cargo build --target wasm32-unknown-unknown --release
```

## ðŸ§ª Insta Snapshot Testing

The project includes a comprehensive snapshot testing system using the [Insta](https://insta.rs/) framework that ensures the compiler and interpreter produce consistent output:

### Test Structure
- **Input Files**: `.imp` files in `tests/snapshots/inputs/`
- **Snapshot Files**: `.snap` files generated by Insta
  - AST snapshots: Parsed Abstract Syntax Trees
  - Opcodes snapshots: Compiled stack machine opcodes
  - Error snapshots: Expected error outputs

### Running Snapshot Tests
```bash
# Run all insta snapshot tests
cargo test --test insta_simple_tests

# Run specific test
./scripts/test-by-name.sh simple_arithmetic

# Using cargo insta (recommended)
cargo insta test --test insta_simple_tests
cargo insta review
cargo insta accept
```

See `tests/snapshots/README.md` for detailed documentation.

## ðŸ“¦ Components

### Core Types (`starstream-types/`)
- **AST**: Abstract Syntax Tree for IMP-like language
- **Opcodes**: Stack machine instruction set
- **Errors**: Comprehensive error handling

### Compiler (`starstream-compiler/`)
- **Parser**: Simple but functional parser for basic expressions
  - Handles variable declarations, assignments, arithmetic
  - Parses binary expressions with proper precedence
- **Compiler**: Compiles AST to stack machine opcodes
  - Handles variable declarations and assignments
  - Generates proper opcode sequences
  - Symbol table management

### Interpreter (`starstream-interpreter/`)
- Plugin architecture with `OpcodeHandler` trait
- Default implementation for all opcodes
- Execution context with stack and variables
- Step-by-step execution capability

## ðŸ”§ Architecture

The project follows a clean separation of concerns:

1. **Parser**: Source code â†’ AST
2. **Compiler**: AST â†’ Stack machine opcodes
3. **Interpreter**: Opcodes â†’ Execution

### Plugin System

The interpreter uses a plugin architecture that makes it easy to extend with new opcode handlers:

```rust
pub trait OpcodeHandler {
    fn handle_opcode(&mut self, opcode: &Opcode, context: &mut ExecutionContext) -> Result<()>;
}
```

## ðŸ“‹ Development Status

### âœ… Completed
- [x] Basic parser for expressions and variable declarations
- [x] AST to opcodes compiler
- [x] Streaming interpreter with plugin architecture
- [x] Complete example demonstrating the pipeline
- [x] Test suite with integration tests
- [x] WASM support for browser deployment

### ðŸš§ In Progress
- [ ] Control flow parsing (if statements, while loops)
- [ ] Enhanced parser with better error recovery
- [ ] Control flow compilation improvements

### ðŸ“‹ Future Features
- [ ] Coroutine support (yield/resume)
- [ ] Algebraic effects system
- [ ] Linear type system
- [ ] Memory consistency checks
- [ ] Full Starstream language features

## ðŸŽ¯ Next Steps

1. **Enhanced Parser**: Add support for `if` statements and `while` loops
2. **Control Flow Compilation**: Improve the compiler's control flow handling
3. **Error Recovery**: Add better error handling and recovery
4. **WASM Optimization**: Optimize for browser performance
5. **Plugin Development**: Create custom opcode handlers for specific use cases

## ðŸ“š References

- [Design Document](docs/design.md) - Architecture and motivation
- [Implementation Plan](impl-plan.md) - Development roadmap

## ðŸ”„ Migration from Split Architecture

This consolidated version merges the following separate crates:
- `starstream-types` â†’ `src/ast.rs`, `src/opcodes.rs`, `src/error.rs`
- `starstream-compiler` â†’ `src/parser.rs`, `src/compiler.rs`
- `starstream-interpreter` â†’ `src/interpreter.rs`
- `starstream-example` â†’ `examples/simple.rs`

All functionality is preserved while providing a single, cohesive codebase.
