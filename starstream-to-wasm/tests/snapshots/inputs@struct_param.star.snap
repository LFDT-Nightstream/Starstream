---
source: starstream-to-wasm/tests/snapshots.rs
input_file: starstream-to-wasm/tests/inputs/struct_param.star
---
==== AST ====
Program {
    shebang: None,
    definitions: [
        Spanned {
            node: Struct(
                StructDef {
                    name: Identifier {
                        name: "Token",
                        span: Some(
                            7..12,
                        ),
                    },
                    fields: [
                        StructField {
                            name: Identifier {
                                name: "amount",
                                span: Some(
                                    19..25,
                                ),
                            },
                            ty: TypeAnnotation {
                                name: Identifier {
                                    name: "i64",
                                    span: Some(
                                        27..30,
                                    ),
                                },
                                generics: [],
                            },
                            span: 19..30,
                        },
                        StructField {
                            name: Identifier {
                                name: "price",
                                span: Some(
                                    36..41,
                                ),
                            },
                            ty: TypeAnnotation {
                                name: Identifier {
                                    name: "i64",
                                    span: Some(
                                        43..46,
                                    ),
                                },
                                generics: [],
                            },
                            span: 36..46,
                        },
                    ],
                },
            ),
            span: 0..51,
        },
        Spanned {
            node: Function(
                FunctionDef {
                    export: Some(
                        Script,
                    ),
                    name: Identifier {
                        name: "total_value",
                        span: Some(
                            61..72,
                        ),
                    },
                    params: [
                        FunctionParam {
                            name: Identifier {
                                name: "token",
                                span: Some(
                                    73..78,
                                ),
                            },
                            ty: TypeAnnotation {
                                name: Identifier {
                                    name: "Token",
                                    span: Some(
                                        80..85,
                                    ),
                                },
                                generics: [],
                            },
                        },
                    ],
                    return_type: Some(
                        TypeAnnotation {
                            name: Identifier {
                                name: "i64",
                                span: Some(
                                    90..93,
                                ),
                            },
                            generics: [],
                        },
                    ),
                    body: Block {
                        statements: [],
                        tail_expression: Some(
                            Spanned {
                                node: Binary {
                                    op: Multiply,
                                    left: Spanned {
                                        node: FieldAccess {
                                            target: Spanned {
                                                node: Identifier(
                                                    Identifier {
                                                        name: "token",
                                                        span: Some(
                                                            100..105,
                                                        ),
                                                    },
                                                ),
                                                span: 100..105,
                                            },
                                            field: Identifier {
                                                name: "amount",
                                                span: Some(
                                                    106..112,
                                                ),
                                            },
                                        },
                                        span: 100..113,
                                    },
                                    right: Spanned {
                                        node: FieldAccess {
                                            target: Spanned {
                                                node: Identifier(
                                                    Identifier {
                                                        name: "token",
                                                        span: Some(
                                                            115..120,
                                                        ),
                                                    },
                                                ),
                                                span: 115..120,
                                            },
                                            field: Identifier {
                                                name: "price",
                                                span: Some(
                                                    121..126,
                                                ),
                                            },
                                        },
                                        span: 115..127,
                                    },
                                },
                                span: 100..127,
                            },
                        ),
                        span: 94..129,
                    },
                },
            ),
            span: 51..129,
        },
    ],
}

==== Inference trace ====

T-Fn: total_value => i64
  T-ReturnTail: token.amount * token.price => i64
    T-Bin-Mul: {token: struct Token {
    amount: i64,
    price: i64,
}} ⊢ token.amount * token.price ⇒ i64
      T-FieldAccess: {token: struct Token {
    amount: i64,
    price: i64,
}} ⊢ token.amount ⇒ i64
        T-Var: {token: struct Token {
    amount: i64,
    price: i64,
}} ⊢ token ⇒ Token
      T-FieldAccess: {token: struct Token {
    amount: i64,
    price: i64,
}} ⊢ token.price ⇒ i64
        T-Var: {token: struct Token {
    amount: i64,
    price: i64,
}} ⊢ token ⇒ Token
      Unify-Const: i64 ~ i64 => {}
      Unify-Const: i64 ~ i64 => {}
    Unify-Const: i64 ~ i64 => {}

==== Typed AST ====
TypedProgram {
    definitions: [
        Struct(
            TypedStructDef {
                name: Identifier {
                    name: "Token",
                    span: Some(
                        7..12,
                    ),
                },
                fields: [
                    TypedStructField {
                        name: Identifier {
                            name: "amount",
                            span: Some(
                                19..25,
                            ),
                        },
                        ty: Int,
                    },
                    TypedStructField {
                        name: Identifier {
                            name: "price",
                            span: Some(
                                36..41,
                            ),
                        },
                        ty: Int,
                    },
                ],
                ty: Record(
                    RecordType {
                        name: "Token",
                        fields: [
                            RecordFieldType {
                                name: "amount",
                                ty: Int,
                            },
                            RecordFieldType {
                                name: "price",
                                ty: Int,
                            },
                        ],
                    },
                ),
            },
        ),
        Function(
            TypedFunctionDef {
                export: Some(
                    Script,
                ),
                name: Identifier {
                    name: "total_value",
                    span: Some(
                        61..72,
                    ),
                },
                params: [
                    TypedFunctionParam {
                        name: Identifier {
                            name: "token",
                            span: Some(
                                73..78,
                            ),
                        },
                        ty: Record(
                            RecordType {
                                name: "Token",
                                fields: [
                                    RecordFieldType {
                                        name: "amount",
                                        ty: Int,
                                    },
                                    RecordFieldType {
                                        name: "price",
                                        ty: Int,
                                    },
                                ],
                            },
                        ),
                    },
                ],
                return_type: Int,
                effect: Pure,
                body: TypedBlock {
                    statements: [],
                    tail_expression: Some(
                        Spanned {
                            node: TypedExpr {
                                ty: Int,
                                kind: Binary {
                                    op: Multiply,
                                    left: Spanned {
                                        node: TypedExpr {
                                            ty: Int,
                                            kind: FieldAccess {
                                                target: Spanned {
                                                    node: TypedExpr {
                                                        ty: Record(
                                                            RecordType {
                                                                name: "Token",
                                                                fields: [
                                                                    RecordFieldType {
                                                                        name: "amount",
                                                                        ty: Int,
                                                                    },
                                                                    RecordFieldType {
                                                                        name: "price",
                                                                        ty: Int,
                                                                    },
                                                                ],
                                                            },
                                                        ),
                                                        kind: Identifier(
                                                            Identifier {
                                                                name: "token",
                                                                span: Some(
                                                                    100..105,
                                                                ),
                                                            },
                                                        ),
                                                    },
                                                    span: 100..105,
                                                },
                                                field: Identifier {
                                                    name: "amount",
                                                    span: Some(
                                                        106..112,
                                                    ),
                                                },
                                            },
                                        },
                                        span: 100..113,
                                    },
                                    right: Spanned {
                                        node: TypedExpr {
                                            ty: Int,
                                            kind: FieldAccess {
                                                target: Spanned {
                                                    node: TypedExpr {
                                                        ty: Record(
                                                            RecordType {
                                                                name: "Token",
                                                                fields: [
                                                                    RecordFieldType {
                                                                        name: "amount",
                                                                        ty: Int,
                                                                    },
                                                                    RecordFieldType {
                                                                        name: "price",
                                                                        ty: Int,
                                                                    },
                                                                ],
                                                            },
                                                        ),
                                                        kind: Identifier(
                                                            Identifier {
                                                                name: "token",
                                                                span: Some(
                                                                    115..120,
                                                                ),
                                                            },
                                                        ),
                                                    },
                                                    span: 115..120,
                                                },
                                                field: Identifier {
                                                    name: "price",
                                                    span: Some(
                                                        121..126,
                                                    ),
                                                },
                                            },
                                        },
                                        span: 115..127,
                                    },
                                },
                            },
                            span: 100..127,
                        },
                    ),
                },
            },
        ),
    ],
}

==== Core WebAssembly ====
(module
  (type (;0;) (func (param i64 i64) (result i64)))
  (export "total-value" (func 1))
  (func (;0;) (type 0) (param i64 i64) (result i64)
    (local i64 i64 i64)
    (local.tee 2
      (i64.mul
        (local.tee 3
          (local.get 0))
        (local.tee 4
          (local.get 1))))
    (if ;; label = @1
      (i32.or
        (i32.and
          (i64.eq
            (local.get 3)
            (i64.const -9223372036854775808))
          (i64.eq
            (local.get 4)
            (i64.const -1)))
        (i32.and
          (i64.eq
            (local.get 4)
            (i64.const -9223372036854775808))
          (i64.eq
            (local.get 3)
            (i64.const -1))))
      (then
        (unreachable)))
    (if ;; label = @1
      (i64.ne
        (local.get 4)
        (i64.const 0))
      (then
        (if ;; label = @2
          (i64.ne
            (i64.div_s
              (local.get 2)
              (local.get 4))
            (local.get 3))
          (then
            (unreachable)))))
  )
  (func (;1;) (type 0) (param i64 i64) (result i64)
    (local i64)
    (call 0
      (local.get 0)
      (drop
        (local.get 1))
      (drop
        (local.get 0)
        (local.set 2
          (local.get 1)))
      (local.get 2))
  )
  (@custom "component-type"
    (component
      (@custom "wit-component-encoding" "\04\00")
      (type (;0;)
        (component
          (type (;0;)
            (component
              (type (;0;) (record (field "amount" s64) (field "price" s64)))
              (import "token" (type (;1;) (eq 0)))
              (type (;2;) (func (param "token" 1) (result s64)))
              (export (;0;) "total-value" (func (type 2)))
            )
          )
          (export (;0;) "my-namespace:my-package/my-world" (component (type 0)))
        )
      )
      (export (;1;) "x" (type 0))
    )
  )
)

==== WIT ====
package root:component;

world root {
  record token {
    amount: s64,
    price: s64,
  }

  export total-value: func(token: token) -> s64;
}
