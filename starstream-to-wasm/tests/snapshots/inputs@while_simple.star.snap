---
source: starstream-to-wasm/tests/snapshots.rs
input_file: starstream-to-wasm/tests/inputs/while_simple.star
---
==== AST ====
Program {
    shebang: None,
    definitions: [
        Spanned {
            node: Function(
                FunctionDef {
                    export: Some(
                        Script,
                    ),
                    name: Identifier {
                        name: "main",
                        span: 10..14,
                    },
                    params: [],
                    return_type: None,
                    body: Block {
                        statements: [
                            Spanned {
                                node: VariableDeclaration {
                                    mutable: true,
                                    name: Identifier {
                                        name: "foo",
                                        span: 31..34,
                                    },
                                    ty: None,
                                    value: Spanned {
                                        node: Literal(
                                            Integer(
                                                0,
                                            ),
                                        ),
                                        span: 37..38,
                                    },
                                },
                                span: 23..44,
                            },
                            Spanned {
                                node: While {
                                    condition: Spanned {
                                        node: Binary {
                                            op: Less,
                                            left: Spanned {
                                                node: Identifier(
                                                    Identifier {
                                                        name: "foo",
                                                        span: 51..54,
                                                    },
                                                ),
                                                span: 51..55,
                                            },
                                            right: Spanned {
                                                node: Literal(
                                                    Integer(
                                                        10,
                                                    ),
                                                ),
                                                span: 57..59,
                                            },
                                        },
                                        span: 51..59,
                                    },
                                    body: Block {
                                        statements: [
                                            Spanned {
                                                node: Assignment {
                                                    target: Identifier {
                                                        name: "foo",
                                                        span: 71..74,
                                                    },
                                                    value: Spanned {
                                                        node: Binary {
                                                            op: Add,
                                                            left: Spanned {
                                                                node: Identifier(
                                                                    Identifier {
                                                                        name: "foo",
                                                                        span: 77..80,
                                                                    },
                                                                ),
                                                                span: 77..81,
                                                            },
                                                            right: Spanned {
                                                                node: Literal(
                                                                    Integer(
                                                                        1,
                                                                    ),
                                                                ),
                                                                span: 83..84,
                                                            },
                                                        },
                                                        span: 77..84,
                                                    },
                                                },
                                                span: 71..90,
                                            },
                                        ],
                                        tail_expression: None,
                                        span: 61..92,
                                    },
                                },
                                span: 44..92,
                            },
                        ],
                        tail_expression: None,
                        span: 17..94,
                    },
                },
            ),
            span: 0..94,
        },
    ],
}

==== Inference trace ====
T-Fn: main => ()
  T-Let: {} ⊢ let mut foo = 0; ⇒ t3
    T-Int: {} ⊢ 0 ⇒ t3
  T-While: {foo: t3} ⊢ while (foo < 10) {
    foo = foo + 1;
} ⇒ ()
    T-Bin-Lt: {foo: t3} ⊢ foo < 10 ⇒ bool
      T-Var: {foo: t3} ⊢ foo ⇒ t3
      T-Int: {foo: t3} ⊢ 10 ⇒ t4
      Check-Compare: t3 vs t4 => ok (int)
        Unify-Var: t3 ~ t4 => {t4/t3}
    Check-Bool: bool => ok
    T-Assign: {foo: t3} ⊢ foo = foo + 1; ⇒ t3
      T-Bin-Add: {foo: t3} ⊢ foo + 1 ⇒ t5
        T-Var: {foo: t3} ⊢ foo ⇒ t3
        T-Int: {foo: t3} ⊢ 1 ⇒ t5
        Unify-Var: t4 ~ t5 => {t5/t4}
      Unify-Var: t5 ~ t5 => {}

==== Typed AST ====
TypedProgram {
    definitions: [
        Function(
            TypedFunctionDef {
                export: Some(
                    Script,
                ),
                name: Identifier {
                    name: "main",
                    span: 10..14,
                },
                params: [],
                return_type: Unit,
                effect: Pure,
                body: TypedBlock {
                    statements: [
                        VariableDeclaration {
                            mutable: true,
                            name: Identifier {
                                name: "foo",
                                span: 31..34,
                            },
                            value: Spanned {
                                node: TypedExpr {
                                    ty: Int(
                                        I64,
                                    ),
                                    kind: Literal(
                                        Integer(
                                            0,
                                        ),
                                    ),
                                },
                                span: 37..38,
                            },
                        },
                        While {
                            condition: Spanned {
                                node: TypedExpr {
                                    ty: Bool,
                                    kind: Binary {
                                        op: Less,
                                        left: Spanned {
                                            node: TypedExpr {
                                                ty: Int(
                                                    I64,
                                                ),
                                                kind: Identifier(
                                                    Identifier {
                                                        name: "foo",
                                                        span: 51..54,
                                                    },
                                                ),
                                            },
                                            span: 51..55,
                                        },
                                        right: Spanned {
                                            node: TypedExpr {
                                                ty: Int(
                                                    I64,
                                                ),
                                                kind: Literal(
                                                    Integer(
                                                        10,
                                                    ),
                                                ),
                                            },
                                            span: 57..59,
                                        },
                                    },
                                },
                                span: 51..59,
                            },
                            body: TypedBlock {
                                statements: [
                                    Assignment {
                                        target: Identifier {
                                            name: "foo",
                                            span: 71..74,
                                        },
                                        value: Spanned {
                                            node: TypedExpr {
                                                ty: Int(
                                                    I64,
                                                ),
                                                kind: Binary {
                                                    op: Add,
                                                    left: Spanned {
                                                        node: TypedExpr {
                                                            ty: Int(
                                                                I64,
                                                            ),
                                                            kind: Identifier(
                                                                Identifier {
                                                                    name: "foo",
                                                                    span: 77..80,
                                                                },
                                                            ),
                                                        },
                                                        span: 77..81,
                                                    },
                                                    right: Spanned {
                                                        node: TypedExpr {
                                                            ty: Int(
                                                                I64,
                                                            ),
                                                            kind: Literal(
                                                                Integer(
                                                                    1,
                                                                ),
                                                            ),
                                                        },
                                                        span: 83..84,
                                                    },
                                                },
                                            },
                                            span: 77..84,
                                        },
                                    },
                                ],
                                tail_expression: None,
                            },
                        },
                    ],
                    tail_expression: None,
                },
            },
        ),
    ],
}

==== Core WebAssembly ====
(module
  (type (;0;) (func (param i64 i64) (result i64)))
  (type (;1;) (func))
  (export "main" (func 1))
  (func (;0;) (type 0) (param i64 i64) (result i64)
    (local i64)
    (local.tee 2
      (i64.add
        (local.get 0)
        (local.get 1)))
    (if ;; label = @1
      (i32.ne
        (i32.and
          (i64.ge_s
            (i64.xor
              (local.get 0)
              (local.get 1))
            (i64.const 0))
          (i64.lt_s
            (i64.xor
              (local.get 2)
              (local.get 0))
            (i64.const 0)))
        (i32.const 0))
      (then
        (unreachable)))
  )
  (func (;1;) (type 1)
    (local i64)
    (local.set 0
      (i64.const 0))
    (block ;; label = @1
      (loop ;; label = @2
        (br_if 1 (;@1;)
          (i32.eqz
            (i64.lt_s
              (local.get 0)
              (i64.const 10))))
        (local.set 0
          (call 0
            (local.get 0)
            (i64.const 1)))
        (br 0 (;@2;))))
  )
  (@custom "component-type"
    (component
      (@custom "wit-component-encoding" "\04\00")
      (type (;0;)
        (component
          (type (;0;)
            (component
              (type (;0;) (func))
              (export (;0;) "main" (func (type 0)))
            )
          )
          (export (;0;) "my-namespace:my-package/my-world" (component (type 0)))
        )
      )
      (export (;1;) "x" (type 0))
    )
  )
)

==== WIT ====
package root:component;

world root {
  export main: func();
}
