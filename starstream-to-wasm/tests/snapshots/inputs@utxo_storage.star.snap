---
source: starstream-to-wasm/tests/snapshots.rs
input_file: starstream-to-wasm/tests/inputs/utxo_storage.star
---
==== AST ====
Program {
    shebang: None,
    definitions: [
        Spanned {
            node: Utxo(
                UtxoDef {
                    name: Identifier {
                        name: "MyUtxo",
                        span: 5..11,
                    },
                    parts: [
                        Storage(
                            [
                                UtxoGlobal {
                                    name: Identifier {
                                        name: "counter",
                                        span: 44..51,
                                    },
                                    ty: TypeAnnotation {
                                        name: Identifier {
                                            name: "i64",
                                            span: 53..56,
                                        },
                                        generics: [],
                                    },
                                },
                                UtxoGlobal {
                                    name: Identifier {
                                        name: "multiplier",
                                        span: 74..84,
                                    },
                                    ty: TypeAnnotation {
                                        name: Identifier {
                                            name: "i64",
                                            span: 86..89,
                                        },
                                        generics: [],
                                    },
                                },
                            ],
                        ),
                        MainFn(
                            FunctionDef {
                                export: Some(
                                    UtxoMain,
                                ),
                                name: Identifier {
                                    name: "increment",
                                    span: 109..118,
                                },
                                params: [],
                                return_type: None,
                                body: Block {
                                    statements: [
                                        Spanned {
                                            node: Assignment {
                                                target: Identifier {
                                                    name: "counter",
                                                    span: 131..138,
                                                },
                                                value: Spanned {
                                                    node: Binary {
                                                        op: Add,
                                                        left: Spanned {
                                                            node: Identifier(
                                                                Identifier {
                                                                    name: "counter",
                                                                    span: 141..148,
                                                                },
                                                            ),
                                                            span: 141..149,
                                                        },
                                                        right: Spanned {
                                                            node: Literal(
                                                                Integer(
                                                                    1,
                                                                ),
                                                            ),
                                                            span: 151..152,
                                                        },
                                                    },
                                                    span: 141..152,
                                                },
                                            },
                                            span: 131..158,
                                        },
                                    ],
                                    tail_expression: None,
                                    span: 121..164,
                                },
                            },
                        ),
                        MainFn(
                            FunctionDef {
                                export: Some(
                                    UtxoMain,
                                ),
                                name: Identifier {
                                    name: "increment_mult",
                                    span: 172..186,
                                },
                                params: [],
                                return_type: None,
                                body: Block {
                                    statements: [
                                        Spanned {
                                            node: Assignment {
                                                target: Identifier {
                                                    name: "multiplier",
                                                    span: 199..209,
                                                },
                                                value: Spanned {
                                                    node: Binary {
                                                        op: Add,
                                                        left: Spanned {
                                                            node: Identifier(
                                                                Identifier {
                                                                    name: "multiplier",
                                                                    span: 212..222,
                                                                },
                                                            ),
                                                            span: 212..223,
                                                        },
                                                        right: Spanned {
                                                            node: Literal(
                                                                Integer(
                                                                    1,
                                                                ),
                                                            ),
                                                            span: 225..226,
                                                        },
                                                    },
                                                    span: 212..226,
                                                },
                                            },
                                            span: 199..232,
                                        },
                                    ],
                                    tail_expression: None,
                                    span: 189..234,
                                },
                            },
                        ),
                    ],
                },
            ),
            span: 0..236,
        },
    ],
}

==== Inference trace ====
T-Utxo: MyUtxo => 
  T-Fn: increment => ()
    T-Assign: {counter: i64, multiplier: i64} ⊢ counter = counter + 1; ⇒ i64
      T-Bin-Add: {counter: i64, multiplier: i64} ⊢ counter + 1 ⇒ i64
        T-Var: {counter: i64, multiplier: i64} ⊢ counter ⇒ i64
        T-Int: {counter: i64, multiplier: i64} ⊢ 1 ⇒ i64
        Unify-Const: i64 ~ i64 => {}
        Unify-Const: i64 ~ i64 => {}
      Unify-Const: i64 ~ i64 => {}
  T-Fn: increment_mult => ()
    T-Assign: {counter: i64, multiplier: i64} ⊢ multiplier = multiplier + 1; ⇒ i64
      T-Bin-Add: {counter: i64, multiplier: i64} ⊢ multiplier + 1 ⇒ i64
        T-Var: {counter: i64, multiplier: i64} ⊢ multiplier ⇒ i64
        T-Int: {counter: i64, multiplier: i64} ⊢ 1 ⇒ i64
        Unify-Const: i64 ~ i64 => {}
        Unify-Const: i64 ~ i64 => {}
      Unify-Const: i64 ~ i64 => {}

==== Typed AST ====
TypedProgram {
    definitions: [
        Utxo(
            TypedUtxoDef {
                name: Identifier {
                    name: "MyUtxo",
                    span: 5..11,
                },
                parts: [
                    Storage(
                        [
                            TypedUtxoGlobal {
                                name: Identifier {
                                    name: "counter",
                                    span: 44..51,
                                },
                                ty: Int,
                            },
                            TypedUtxoGlobal {
                                name: Identifier {
                                    name: "multiplier",
                                    span: 74..84,
                                },
                                ty: Int,
                            },
                        ],
                    ),
                    MainFn(
                        TypedFunctionDef {
                            export: Some(
                                UtxoMain,
                            ),
                            name: Identifier {
                                name: "increment",
                                span: 109..118,
                            },
                            params: [],
                            return_type: Unit,
                            effect: Pure,
                            body: TypedBlock {
                                statements: [
                                    Assignment {
                                        target: Identifier {
                                            name: "counter",
                                            span: 131..138,
                                        },
                                        value: Spanned {
                                            node: TypedExpr {
                                                ty: Int,
                                                kind: Binary {
                                                    op: Add,
                                                    left: Spanned {
                                                        node: TypedExpr {
                                                            ty: Int,
                                                            kind: Identifier(
                                                                Identifier {
                                                                    name: "counter",
                                                                    span: 141..148,
                                                                },
                                                            ),
                                                        },
                                                        span: 141..149,
                                                    },
                                                    right: Spanned {
                                                        node: TypedExpr {
                                                            ty: Int,
                                                            kind: Literal(
                                                                Integer(
                                                                    1,
                                                                ),
                                                            ),
                                                        },
                                                        span: 151..152,
                                                    },
                                                },
                                            },
                                            span: 141..152,
                                        },
                                    },
                                ],
                                tail_expression: None,
                            },
                        },
                    ),
                    MainFn(
                        TypedFunctionDef {
                            export: Some(
                                UtxoMain,
                            ),
                            name: Identifier {
                                name: "increment_mult",
                                span: 172..186,
                            },
                            params: [],
                            return_type: Unit,
                            effect: Pure,
                            body: TypedBlock {
                                statements: [
                                    Assignment {
                                        target: Identifier {
                                            name: "multiplier",
                                            span: 199..209,
                                        },
                                        value: Spanned {
                                            node: TypedExpr {
                                                ty: Int,
                                                kind: Binary {
                                                    op: Add,
                                                    left: Spanned {
                                                        node: TypedExpr {
                                                            ty: Int,
                                                            kind: Identifier(
                                                                Identifier {
                                                                    name: "multiplier",
                                                                    span: 212..222,
                                                                },
                                                            ),
                                                        },
                                                        span: 212..223,
                                                    },
                                                    right: Spanned {
                                                        node: TypedExpr {
                                                            ty: Int,
                                                            kind: Literal(
                                                                Integer(
                                                                    1,
                                                                ),
                                                            ),
                                                        },
                                                        span: 225..226,
                                                    },
                                                },
                                            },
                                            span: 212..226,
                                        },
                                    },
                                ],
                                tail_expression: None,
                            },
                        },
                    ),
                ],
            },
        ),
    ],
}

==== Core WebAssembly ====
(module
  (type (;0;) (func (param i64 i64) (result i64)))
  (type (;1;) (func))
  (type (;2;) (func (result i64 i64)))
  (type (;3;) (func (result i32)))
  (type (;4;) (func (param i64 i64)))
  (memory (;0;) 1)
  (global (;0;) (mut i64) (i64.const 0))
  (global (;1;) (mut i64) (i64.const 0))
  (export "increment" (func 1))
  (export "increment-mult" (func 2))
  (export "get-storage" (func 4))
  (export "set-storage" (func 5))
  (export "memory" (memory 0))
  (func (;0;) (type 0) (param i64 i64) (result i64)
    (local i64)
    (local.tee 2
      (i64.add
        (local.get 0)
        (local.get 1)))
    (if ;; label = @1
      (i32.ne
        (i32.and
          (i64.ge_s
            (i64.xor
              (local.get 0)
              (local.get 1))
            (i64.const 0))
          (i64.lt_s
            (i64.xor
              (local.get 2)
              (local.get 0))
            (i64.const 0)))
        (i32.const 0))
      (then
        (unreachable)))
  )
  (func (;1;) (type 1)
    (global.set 0
      (call 0
        (global.get 0)
        (i64.const 1)))
  )
  (func (;2;) (type 1)
    (global.set 1
      (call 0
        (global.get 1)
        (i64.const 1)))
  )
  (func (;3;) (type 2) (result i64 i64)
    (global.get 0)
    (global.get 1)
  )
  (func (;4;) (type 3) (result i32)
    (local i32 i64 i64)
    (i32.const 8)
    (call 3)
    (local.set 2)
    (local.set 1)
    (local.set 0)
    (i64.store
      (local.get 0)
      (local.get 1))
    (i64.store offset=8
      (local.get 0)
      (local.get 2))
    (i32.const 8)
  )
  (func (;5;) (type 4) (param i64 i64)
    (local i64)
    (global.set 0
      (local.get 0)
      (drop
        (local.get 1)))
    (drop
      (local.get 0)
      (local.set 2
        (local.get 1)))
    (global.set 1
      (local.get 2))
  )
  (@custom "component-type"
    (component
      (@custom "wit-component-encoding" "\04\00")
      (type (;0;)
        (component
          (type (;0;)
            (component
              (type (;0;) (func))
              (export (;0;) "increment" (func (type 0)))
              (type (;1;) (func))
              (export (;1;) "increment-mult" (func (type 1)))
              (type (;2;) (record (field "counter" s64) (field "multiplier" s64)))
              (import "my-utxo" (type (;3;) (eq 2)))
              (type (;4;) (func (result 3)))
              (export (;2;) "get-storage" (func (type 4)))
              (type (;5;) (func (param "storage" 3)))
              (export (;3;) "set-storage" (func (type 5)))
            )
          )
          (export (;0;) "my-namespace:my-package/my-world" (component (type 0)))
        )
      )
      (export (;1;) "x" (type 0))
    )
  )
)

==== WIT ====
package root:component;

world root {
  record my-utxo {
    counter: s64,
    multiplier: s64,
  }

  export increment: func();
  export increment-mult: func();
  export get-storage: func() -> my-utxo;
  export set-storage: func(storage: my-utxo);
}
